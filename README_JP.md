# 新潟バドミントン自動予約システム

新潟市スポーツ施設のバドミントンコートを自動で予約するPythonプログラムです。

## 主な機能

- 希望日（本日から5日後）・時間帯のバドミントンコートを自動予約
- 空きコートを自動検索し、複数コート同時予約（COURT_NO指定）
- FACILITY_NAME, FACILITY_IDはキーワード（例：HIGASHI, KITA等）で自動変換
- CSRFトークン自動処理・予約成功ログ出力
- 高速な予約処理（1～2秒以内）

## インストール方法

### 1. Pythonのインストール
Python 3.7以上が必要です。

### 2. 必要なライブラリのインストール
```bash
pip install -r requirements.txt
```

## 使い方

### 1. 予約情報の入力
1) サンプルファイルをコピー
```bash
cp my_data.json.sample my_data.json
```
2) `my_data.json`ファイルを以下のように編集してください：

```json
{
  "NAME": "山田太郎",
  "PHONE_NUMBER": "09012345678",
  "E_MAIL": "your-email@gmail.com",
  "TIME": "15-17",
  "FACILITY_NAME": "TOYANO",  // HIGASHI, KITA, TOYANO, NISHI, KAMEDA から選択
  "COURT_NO": "2"              // 予約したいコート数（省略時は1）
}
```

**フィールド説明：**
- `NAME`: 予約者名
- `PHONE_NUMBER`: 電話番号（ハイフンなし）
- `E_MAIL`: メールアドレス
- `TIME`: 予約時間帯（例："9-11", "13-15", "15-17"）
- `FACILITY_NAME`: 体育館キーワード（上記参照）
- `COURT_NO`: 予約したいコート数（省略時は1）

### 2. プログラムの実行
#### (1) 直接実行
```bash
python main.py
```

#### (2) スクリプトで実行（推奨）
OSに合わせて以下のスクリプトを利用してください：

##### macOS/Linux
```bash
# 初回のみ実行権限を付与
chmod +x start_booking.sh nightly_update.sh

# 実行
sh start_booking.sh
```

##### Windows
```cmd
start_booking.bat
```

#### (3) 予約実行（自動化）
##### macOS: cron 登録例
```bash
crontab -e
# 毎週土曜午前7時に予約実行
0 7 * * 6 cd /Users/yourname/autoBooking && sh start_booking.sh

# 毎日午前1時に自動アップデート（mainブランチ最新化）
0 1 * * * cd /Users/yourname/autoBooking && sh nightly_update.sh
```

##### Windows: タスクスケジューラ登録
1. タスクスケジューラを起動 → 「基本タスクの作成」クリック
2. トリガー：希望の予約時間を設定（例：毎週土曜午前7時）
3. 操作：プログラム/スクリプトに `start_booking.bat` のパスを指定
4. 完了後、自動実行されます

##### Windows: 自動アップデート登録例
1. タスクスケジューラを起動 → 「基本タスクの作成」クリック
2. トリガー：毎日午前1時に設定
3. 操作：プログラム/スクリプトに `nightly_update.bat` のパスを指定
4. 完了後、自動実行されます

### 3. 実行結果の確認
コンソールや`reservation.log`ファイルで予約結果を確認できます。

## プログラム構成

```
├── main.py                    # メイン実行ファイル
├── modules/
│   ├── get_date_id.py            # 日付ID取得モジュール
│   ├── get_reservation_ids.py    # 空きコート取得モジュール
│   └── niigata_macro.py          # 予約実行モジュール
├── my_data.json              # ユーザー予約情報
├── requirements.txt          # 必要ライブラリ一覧
├── README.md                 # 日本語説明書
└── reservation.log           # 実行ログ（自動生成）
```

## 動作概要

1. **日付ID取得**：予約希望日（本日+5日）のIDをWebサイトから取得
2. **コート検索**：該当日・時間帯の空きコートを検索
3. **CSRFトークン取得**：予約ページからセキュリティトークン取得
4. **予約確認・実行**：予約情報を送信し予約完了

## 予約可能時間帯

- 9-11時
- 11-13時
- 13-15時
- 15-17時
- 17-19時
- 19-21時

## 注意事項

⚠️ **重要な制限事項**

1. **Rate Limit**：Webサイトは1分あたり約5回までリクエスト可能。過度な実行は429エラーとなります。
2. **予約可能期間**：Webサイトの予約可能期間に従ってください。
3. **重複予約防止**：既に予約済みのコートは自動予約されません。
4. **コート選択**：複数空きがある場合、COURT_NO分だけ順に予約します。

## トラブルシューティング

### 空きコートがない場合
- その時間帯の全コートが既に予約済みです。
- 他の時間帯や日付をお試しください。

### 429エラーが出る場合
- リクエスト過多です。
- 30秒～1分待ってから再実行してください。

### CSRFトークンエラー
- Webサイトのセッションが切れた場合です。
- プログラムを再実行すれば自動で解決します。

### ValueError: too many values to unpack
- `get_reservation_ids.py`が古い場合に発生します。
- 最新版に差し替えてください。

## ログ確認

`reservation.log`ファイルで以下を確認できます：
- 日付ID取得結果
- 空きコート一覧
- 選択コート情報
- CSRFトークン取得状況
- 予約リクエスト応答コード
- 予約成功/失敗
- 総所要時間

**ログ例：**
```
2025-10-12 01:42:02,844 - INFO - 空きコート: ['バドミントン 1 (ID: 250514)', 'バドミントン 2 (ID: 250521)']
2025-10-12 01:42:02,844 - INFO - 選択コート: バドミントン 1 (ID: 250514)
2025-10-12 01:42:02,844 - INFO - 予約完了 - コート: バドミントン 1
2025-10-12 01:42:02,845 - INFO - === 予約が正常に完了しました! ===
2025-10-12 01:42:02,845 - INFO - 予約済みコート: バドミントン 1
2025-10-12 01:42:02,845 - INFO - 総所要時間: 1.56秒
```

## 成功例

```
[成功] 予約が正常に完了しました!
予約コート: バドミントン 1
所要時間: 1.56秒
```
