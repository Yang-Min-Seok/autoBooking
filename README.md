# 니이가타 배드민턴 자동 예약 시스템

니이가타시 스포츠 시설 배드민턴 코트를 자동으로 예약하는 Python 프로그램입니다.

## 주요 기능

- 원하는 날짜(오늘 기준 7일 뒤)와 시간대의 배드민턴 코트 자동 예약
- 예약 가능한 코트 자동 검색 및 여러 코트 동시 예약 (COURT_NO 지정)
- FACILITY_NAME, FACILITY_ID 키워드 자동 매핑 지원 (예: HIGASHI, KITA 등)
- CSRF 토큰 자동 처리 및 예약 성공 여부 로깅
- 빠른 예약 처리 (1~2초 내)

## 설치 방법

### 1. Python 설치
Python 3.7 이상이 필요합니다.

### 2. 필요한 라이브러리 설치
```bash
pip install -r requirements.txt
```

## 사용 방법

### 1. 예약 정보 입력
1) 샘플 파일 복사
```bash
cp my_data.json.sample my_data.json
```
2) `my_data.json` 파일을 아래와 같이 수정합니다:

```json
{
  "NAME": "홍길동",
  "PHONE_NUMBER": "01012345678",
  "E_MAIL": "your-email@gmail.com",
  "TIME": "15-17",
  "FACILITY_NAME": "TOYANO",  // HIGASHI, KITA, TOYANO, NISHI, KAMEDA 중 택1
  "COURT_NO": "2"              // 예약할 코트 개수(기본값 1)
}
```

**필드 설명:**
- `NAME`: 예약자 이름
- `PHONE_NUMBER`: 전화번호 (하이픈 없이 입력)
- `E_MAIL`: 이메일 주소
- `TIME`: 예약 시간대 (예: "9-11", "13-15", "15-17")
- `FACILITY_NAME`: 체육관 키워드 (위 예시 참고)
- `COURT_NO`: 예약할 코트 개수(생략 시 1)

### 2. 프로그램 실행
#### (1) 직접 실행
```bash
python main.py
```

#### (2) 스크립트로 실행 (권장)
운영체제에 맞는 스크립트를 사용하세요:

##### macOS/Linux
```bash
# 최초 1회만 실행 권한 부여
chmod +x start_booking.sh nightly_update.sh

# 실행
sh start_booking.sh
```

##### Windows
```cmd
start_booking.bat
```

#### (3) 예약 실행(자동화)
##### macOS: cron 등록 예시
```bash
crontab -e
# 매주 토요일 오전 7시 예약 실행
0 7 * * 6 cd /Users/yourname/autoBooking && sh start_booking.sh
 
# 매일 새벽 1시 자동 업데이트 (main 브랜치 최신화)
0 1 * * * cd /Users/yourname/autoBooking && sh nightly_update.sh
```

##### Windows: 작업 스케줄러 등록
1. 작업 스케줄러 실행 → "기본 작업 만들기" 클릭
2. 트리거: 원하는 예약 시간 설정(예: 매주 토요일 오전 7시)
3. 동작: 프로그램/스크립트에 `start_booking.bat` 경로 지정
4. 완료 후 자동 실행

##### Windows: 자동 업데이트 등록 예시
1. 작업 스케줄러 실행 → "기본 작업 만들기" 클릭
2. 트리거: 매일 새벽 1시로 설정
3. 동작: 프로그램/스크립트에 `nightly_update.bat` 경로 지정
4. 완료 후 자동 실행

### 3. 실행 결과 확인
콘솔 및 `reservation.log` 파일에서 예약 결과를 확인할 수 있습니다.

## 프로그램 구조

```
├── main.py                    # 메인 실행 파일
├── modules/
│   ├── get_date_id.py            # 날짜 ID 조회 모듈
│   ├── get_reservation_ids.py    # 예약 가능한 코트 조회 모듈
│   └── niigata_macro.py          # 예약 실행 모듈
├── my_data.json              # 사용자 예약 정보
├── requirements.txt          # 필요한 라이브러리 목록
├── README.md                 # 사용 설명서
└── reservation.log           # 실행 로그 (자동 생성)
```

## 작동 원리

1. **날짜 ID 조회**: 예약하려는 날짜(오늘+5일)의 고유 ID를 웹사이트에서 조회
2. **코트 검색**: 해당 날짜와 시간대에 예약 가능한 코트 검색
3. **CSRF 토큰 획득**: 예약 페이지에서 보안 토큰 획득
4. **예약 확인/실행**: 예약 정보를 전송하여 예약 완료

## 예약 가능 시간대

- 9-11시
- 11-13시
- 13-15시
- 15-17시
- 17-19시
- 19-21시

## 주의사항

⚠️ **중요한 제한사항**

1. **Rate Limit**: 웹사이트는 분당 약 5회 요청 제한이 있습니다. 너무 자주 실행하면 429 에러가 발생할 수 있습니다.
2. **예약 가능 기간**: 웹사이트의 예약 가능 기간 정책을 따릅니다.
3. **중복 예약 방지**: 이미 예약된 코트는 자동으로 예약할 수 없습니다.
4. **코트 선택**: 여러 코트가 비어있을 경우 COURT_NO만큼 순서대로 예약합니다.

## 문제 해결

### 예약 가능한 코트가 없다고 나올 때
- 해당 시간대의 모든 코트가 이미 예약된 상태입니다.
- 다른 시간대를 선택하거나 다른 날짜를 시도해보세요.

### 429 에러가 발생할 때
- 너무 많은 요청을 보낸 경우입니다.
- 30초~1분 정도 기다린 후 다시 시도하세요.

### CSRF 토큰 오류
- 웹사이트 세션이 만료된 경우입니다.
- 프로그램을 다시 실행하면 자동으로 해결됩니다.

### ValueError: too many values to unpack
- `get_reservation_ids.py` 파일이 업데이트되지 않은 경우입니다.
- 최신 버전의 파일로 교체해주세요.

## 로그 확인

`reservation.log` 파일에서 다음 정보를 확인할 수 있습니다:
- 날짜 ID 조회 결과
- 예약 가능한 코트 목록 (코트 번호 포함)
- 선택된 코트 정보
- CSRF 토큰 획득 여부
- 예약 요청 응답 코드
- 예약 성공/실패 여부
- 총 소요 시간

**로그 예시:**
```
2025-10-12 01:42:02,844 - INFO - 예약 가능한 코트들: ['バドミントン 1 (ID: 250514)', 'バドミントン 2 (ID: 250521)']
2025-10-12 01:42:02,844 - INFO - 선택된 코트: バドミントン 1 (ID: 250514)
2025-10-12 01:42:02,844 - INFO - 예약 완료 - 코트: バドミントン 1
2025-10-12 01:42:02,845 - INFO - === 예약이 성공적으로 완료되었습니다! ===
2025-10-12 01:42:02,845 - INFO - 예약된 코트: バドミントン 1
2025-10-12 01:42:02,845 - INFO - 총 소요 시간: 1.56초
```

## 성공 예시

```
[성공] 예약이 성공적으로 완료되었습니다!
예약 코트: バドミントン 1
소요시간: 1.56초
```

## 📌 버전 기록

| 날짜 | 버전 | 변경 내용 |
|---|---:|---|
| 2025-04-09 | 1.0.0 | 첫 배포 (Selenium 기반) |
| 2025-04-13 | 1.0.1 | Selenium 기반 속도 개선 |
| 2025-04-14 | 2.0.0 | Playwright 버전 도입 및 속도 개선 |
| 2025-04-19 | 2.0.1 | 코트, 시간 지정 기능 추가, 매직넘버 변수화 |
| 2025-04-23 | 2.1.1 | 체육관 지정 기능 추가(카메다), 예약 실패 반응 속도 단축 |
| 2025-05-10 | 2.2.0 | 체육관 옵션 추가(토야노) |
| 2025-06-02 | 2.2.1 | 에러 대응, 안정성 형상 |
| 2025-06-28 | 3.0.0 | 다중 코트 대응(3코트까지), 속도 개선 |
| 2025-07-26 | 3.1.0 | 체육관 옵션 추가(西, 北), 날짜 버그 개선 |
| 2025-07-27 | 3.2.0 | nightly update 기능 추가 |
| 2025-10-12 | 4.0.0 | api기반 속도 개선 |
| 2025-10-12 | 4.1.0 | 자동화 툴 제공 (start_booking, nightly_update) |

## ✅ 라이선스 및 제작자

- Maintained by [kurooru]
- License: kurooru

## 📔 개발 일지

[개발 일지 (Notion)](https://www.notion.so/NEMMY-DARRY-MENDY-208b163aeba780e09715c8992b99829a?source=copy_link)